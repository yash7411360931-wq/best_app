<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üå± Plant Disease Detector</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #ff0000 0%, #ff7f00 20%, #ffff00 40%, #00ff00 60%, #0000ff 80%, #8b00ff 100%);
            background-size: 400% 400%;
            min-height: 100vh;
            padding: 20px;
            animation: rainbowSlide 15s ease-in-out infinite;
        }

        @keyframes rainbowSlide {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            animation: fadeIn 0.8s ease-in;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .language-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 1000;
        }

        .lang-btn {
            padding: 10px 20px;
            border: 2px solid white;
            background: rgba(255,255,255,0.2);
            color: white;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .lang-btn.active {
            background: white;
            color: #667eea;
        }

        .lang-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .install-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 10px 20px;
            background: #48bb78;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(72,187,120,0.4);
            transition: all 0.3s;
            z-index: 1000;
        }

        .install-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(72,187,120,0.6);
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            animation: slideUp 0.6s ease-out;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(102,126,234,0.05);
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: rgba(102,126,234,0.1);
            transform: scale(1.02);
        }

        .upload-area img {
            max-width: 100%;
            max-height: 300px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin: 10px 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102,126,234,0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #e53e3e;
            color: white;
        }

        .btn-secondary:hover {
            background: #c53030;
            transform: translateY(-2px);
        }

        .result-box {
            background: #f7fafc;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            min-height: 200px;
        }

        .result-box h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .chat-container {
            background: #f7fafc;
            border-radius: 10px;
            padding: 15px;
            height: 400px;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 15px;
            padding: 10px;
        }

        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 10px;
            max-width: 80%;
            animation: messageSlide 0.3s ease-out;
        }

        .message.user {
            background: #667eea;
            color: white;
            margin-left: auto;
        }

        .message.ai {
            background: white;
            color: #2d3748;
            border: 1px solid #e2e8f0;
        }

        .chat-input-area {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #667eea;
            border-radius: 10px;
            font-size: 1em;
        }

        .example-questions {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .example-q {
            padding: 8px 15px;
            background: rgba(102,126,234,0.1);
            border: 1px solid #667eea;
            border-radius: 20px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s;
        }

        .example-q:hover {
            background: #667eea;
            color: white;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes messageSlide {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            .language-toggle {
                top: 10px;
                right: 10px;
            }
            .install-btn {
                top: 10px;
                left: 10px;
                padding: 8px 15px;
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body>
    <button class="install-btn" onclick="showInstallGuide()">üì• <span data-en="Install App" data-hi="‡§ê‡§™ ‡§á‡§Ç‡§∏‡•ç‡§ü‡•â‡§≤ ‡§ï‡§∞‡•á‡§Ç">Install App</span></button>
    
    <div class="language-toggle">
        <button class="lang-btn active" onclick="setLanguage('en')">English</button>
        <button class="lang-btn" onclick="setLanguage('hi')">‡§π‡§ø‡§Ç‡§¶‡•Ä</button>
    </div>

    <div class="container">
        <div class="header">
            <h1>üå± <span data-en="Plant Disease Detector" data-hi="‡§™‡•å‡§ß‡•á ‡§∞‡•ã‡§ó ‡§°‡§ø‡§ü‡•á‡§ï‡•ç‡§ü‡§∞">Plant Disease Detector</span></h1>
            <p data-en="AI-Powered Plant Health Analysis" data-hi="AI ‡§∏‡•á ‡§™‡•å‡§ß‡•ã‡§Ç ‡§ï‡•Ä ‡§∏‡•á‡§π‡§§ ‡§ï‡§æ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£">AI-Powered Plant Health Analysis</p>
        </div>

        <div class="main-grid">
            <div class="card">
                <h2 data-en="Upload Plant Image" data-hi="‡§™‡•å‡§ß‡•á ‡§ï‡•Ä ‡§´‡•ã‡§ü‡•ã ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç">Upload Plant Image</h2>
                <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                    <p data-en="üì∏ Click or drag to upload plant image" data-hi="üì∏ ‡§´‡•ã‡§ü‡•ã ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç">üì∏ Click or drag to upload plant image</p>
                    <input type="file" id="fileInput" accept="image/*" style="display:none" onchange="handleFileSelect(event)">
                    <img id="previewImage" style="display:none">
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" id="detectBtn" onclick="detectDisease()" disabled>
                        <span data-en="üîç Detect Disease" data-hi="üîç ‡§∞‡•ã‡§ó ‡§ï‡§æ ‡§™‡§§‡§æ ‡§≤‡§ó‡§æ‡§è‡§Ç">üîç Detect Disease</span>
                    </button>
                    <button class="btn btn-secondary" onclick="clearAll()">
                        <span data-en="üóëÔ∏è Clear" data-hi="üóëÔ∏è ‡§∏‡§æ‡§´ ‡§ï‡§∞‡•á‡§Ç">üóëÔ∏è Clear</span>
                    </button>
                </div>
            </div>

            <div class="card">
                <h2 data-en="Analysis Result" data-hi="‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§™‡§∞‡§ø‡§£‡§æ‡§Æ">Analysis Result</h2>
                <div class="result-box" id="resultBox">
                    <p data-en="Upload an image and click detect to see results..." data-hi="‡§™‡§∞‡§ø‡§£‡§æ‡§Æ ‡§¶‡•á‡§ñ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§´‡•ã‡§ü‡•ã ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ ‡§°‡§ø‡§ü‡•á‡§ï‡•ç‡§ü ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç...">Upload an image and click detect to see results...</p>
                </div>
                <div style="text-align: center; margin-top: 15px;">
                    <button class="btn btn-primary" onclick="downloadReport()">
                        <span data-en="üì• Download" data-hi="üì• ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°">üì• Download</span>
                    </button>
                    <button class="btn btn-primary" onclick="shareReport()">
                        <span data-en="üì§ Share" data-hi="üì§ ‡§∂‡•á‡§Ø‡§∞">üì§ Share</span>
                    </button>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>ü§ñ <span data-en="AI Plant Doctor Chat" data-hi="AI ‡§™‡•ç‡§≤‡§æ‡§Ç‡§ü ‡§°‡•â‡§ï‡•ç‡§ü‡§∞ ‡§ö‡•à‡§ü">AI Plant Doctor Chat</span></h2>
            <p data-en="Ask me anything about plant diseases, treatments, and care!" data-hi="‡§™‡•å‡§ß‡•ã‡§Ç ‡§ï‡•Ä ‡§¨‡•Ä‡§Æ‡§æ‡§∞‡§ø‡§Ø‡•ã‡§Ç, ‡§â‡§™‡§ö‡§æ‡§∞ ‡§î‡§∞ ‡§¶‡•á‡§ñ‡§≠‡§æ‡§≤ ‡§ï‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§ï‡•Å‡§õ ‡§≠‡•Ä ‡§™‡•Ç‡§õ‡•á‡§Ç!">Ask me anything about plant diseases, treatments, and care!</p>
            
            <div class="example-questions">
                <span class="example-q" onclick="askQuestion(this)" data-en="How to treat leaf blight?" data-hi="‡§™‡§§‡•ç‡§§‡§ø‡§Ø‡•ã‡§Ç ‡§ï‡•Ä ‡§ù‡•Å‡§≤‡§∏‡§® ‡§ï‡§æ ‡§á‡§≤‡§æ‡§ú ‡§ï‡•à‡§∏‡•á ‡§ï‡§∞‡•á‡§Ç?">How to treat leaf blight?</span>
                <span class="example-q" onclick="askQuestion(this)" data-en="What causes yellow leaves?" data-hi="‡§™‡•Ä‡§≤‡•Ä ‡§™‡§§‡•ç‡§§‡§ø‡§Ø‡§æ‡§Ç ‡§ï‡•ç‡§Ø‡•ã‡§Ç ‡§π‡•ã‡§§‡•Ä ‡§π‡•à‡§Ç?">What causes yellow leaves?</span>
                <span class="example-q" onclick="askQuestion(this)" data-en="Best organic pesticide?" data-hi="‡§∏‡§¨‡§∏‡•á ‡§Ö‡§ö‡•ç‡§õ‡§æ ‡§ú‡•à‡§µ‡§ø‡§ï ‡§ï‡•Ä‡§ü‡§®‡§æ‡§∂‡§ï?">Best organic pesticide?</span>
            </div>

            <div class="chat-container">
                <div class="chat-messages" id="chatMessages"></div>
                <div class="chat-input-area">
                    <input type="text" class="chat-input" id="chatInput" data-en-placeholder="Ask me about your plant..." data-hi-placeholder="‡§Ö‡§™‡§®‡•á ‡§™‡•å‡§ß‡•á ‡§ï‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§™‡•Ç‡§õ‡•á‡§Ç..." placeholder="Ask me about your plant..." onkeypress="if(event.key==='Enter') sendChatMessage()">
                    <button class="btn btn-primary" onclick="sendChatMessage()">üì§</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentLang = 'en';
        let selectedImage = null;
        let lastAnalysis = null;
        const API_KEY = 'sk-or-v1-cc8b6ea2043f12339650ac5 0e4d054572be212448f1dc1094225daff42b3e58c'.replace(/ /g, '');

        function setLanguage(lang) {
            currentLang = lang;
            document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            document.querySelectorAll('[data-en]').forEach(el => {
                el.textContent = el.getAttribute('data-' + lang);
            });
            
            const chatInput = document.getElementById('chatInput');
            chatInput.placeholder = lang === 'en' ? 'Ask me about your plant...' : '‡§Ö‡§™‡§®‡•á ‡§™‡•å‡§ß‡•á ‡§ï‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§™‡•Ç‡§õ‡•á‡§Ç...';
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    selectedImage = e.target.result;
                    const preview = document.getElementById('previewImage');
                    preview.src = selectedImage;
                    preview.style.display = 'block';
                    document.getElementById('detectBtn').disabled = false;
                };
                reader.readAsDataURL(file);
            }
        }

        async function detectDisease() {
            if (!selectedImage) return;

            const btn = document.getElementById('detectBtn');
            const resultBox = document.getElementById('resultBox');
            
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> ' + (currentLang === 'en' ? 'Analyzing...' : '‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...');
            resultBox.innerHTML = '<p>' + (currentLang === 'en' ? 'üîç Analyzing plant image...' : 'üîç ‡§™‡•å‡§ß‡•á ‡§ï‡•Ä ‡§´‡•ã‡§ü‡•ã ‡§ï‡§æ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...') + '</p>';

            try {
                const base64Image = selectedImage.split(',')[1];
                const mimeType = selectedImage.split(';')[0].split(':')[1];
                
                const prompt = currentLang === 'en' 
                    ? `Analyze this plant leaf image and provide a detailed diagnosis:
                    
1. Disease Name: Identify the specific disease (if any)
2. Symptoms: Describe visible symptoms
3. Treatment: Recommend treatment methods (both organic and chemical)
4. Climate: Ideal conditions to prevent this disease
5. Prevention: Tips to prevent future occurrences

Format the response clearly with headings.`
                    : `‡§á‡§∏ ‡§™‡•å‡§ß‡•á ‡§ï‡•Ä ‡§™‡§§‡•ç‡§§‡•Ä ‡§ï‡•Ä ‡§´‡•ã‡§ü‡•ã ‡§ï‡§æ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ ‡§µ‡§ø‡§∏‡•ç‡§§‡•É‡§§ ‡§®‡§ø‡§¶‡§æ‡§® ‡§™‡•ç‡§∞‡§¶‡§æ‡§® ‡§ï‡§∞‡•á‡§Ç:

1. ‡§∞‡•ã‡§ó ‡§ï‡§æ ‡§®‡§æ‡§Æ: ‡§µ‡§ø‡§∂‡§ø‡§∑‡•ç‡§ü ‡§∞‡•ã‡§ó ‡§ï‡•Ä ‡§™‡§π‡§ö‡§æ‡§® ‡§ï‡§∞‡•á‡§Ç (‡§Ø‡§¶‡§ø ‡§ï‡•ã‡§à ‡§π‡•ã)
2. ‡§≤‡§ï‡•ç‡§∑‡§£: ‡§¶‡§ø‡§ñ‡§æ‡§à ‡§¶‡•á‡§®‡•á ‡§µ‡§æ‡§≤‡•á ‡§≤‡§ï‡•ç‡§∑‡§£‡•ã‡§Ç ‡§ï‡§æ ‡§µ‡§∞‡•ç‡§£‡§® ‡§ï‡§∞‡•á‡§Ç
3. ‡§â‡§™‡§ö‡§æ‡§∞: ‡§â‡§™‡§ö‡§æ‡§∞ ‡§ï‡•á ‡§§‡§∞‡•Ä‡§ï‡•á ‡§∏‡•Å‡§ù‡§æ‡§è‡§Ç (‡§ú‡•à‡§µ‡§ø‡§ï ‡§î‡§∞ ‡§∞‡§æ‡§∏‡§æ‡§Ø‡§®‡§ø‡§ï ‡§¶‡•ã‡§®‡•ã‡§Ç)
4. ‡§ú‡§≤‡§µ‡§æ‡§Ø‡•Å: ‡§á‡§∏ ‡§∞‡•ã‡§ó ‡§ï‡•ã ‡§∞‡•ã‡§ï‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ü‡§¶‡§∞‡•ç‡§∂ ‡§∏‡•ç‡§•‡§ø‡§§‡§ø‡§Ø‡§æ‡§Ç
5. ‡§∞‡•ã‡§ï‡§•‡§æ‡§Æ: ‡§≠‡§µ‡§ø‡§∑‡•ç‡§Ø ‡§Æ‡•á‡§Ç ‡§∞‡•ã‡§ï‡§®‡•á ‡§ï‡•á ‡§ü‡§ø‡§™‡•ç‡§∏

‡§∏‡•ç‡§™‡§∑‡•ç‡§ü ‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï‡•ã‡§Ç ‡§ï‡•á ‡§∏‡§æ‡§• ‡§ú‡§µ‡§æ‡§¨ ‡§¶‡•á‡§Ç‡•§`;

                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Content-Type': 'application/json',
                        'HTTP-Referer': window.location.href,
                        'X-Title': 'Plant Disease Detector'
                    },
                    body: JSON.stringify({
                        model: 'anthropic/claude-3.5-sonnet',
                        messages: [{
                            role: 'user',
                            content: [
                                { type: 'text', text: prompt },
                                { 
                                    type: 'image_url', 
                                    image_url: { url: `data:${mimeType};base64,${base64Image}` }
                                }
                            ]
                        }]
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API Error Response:', errorText);
                    throw new Error(`API Error ${response.status}: ${errorText}`);
                }

                const data = await response.json();
                console.log('API Response:', data);

                if (data.choices && data.choices[0] && data.choices[0].message) {
                    lastAnalysis = data.choices[0].message.content;
                    resultBox.innerHTML = `<div style="white-space: pre-wrap;">${lastAnalysis}</div>`;
                } else {
                    throw new Error('Invalid response format from API');
                }

            } catch (error) {
                console.error('Error:', error);
                const errorMsg = error.message;
                
                resultBox.innerHTML = `<p style="color: red;">‚ùå ${errorMsg}</p>
                    <p style="font-size: 0.9em; margin-top: 10px; font-weight: bold;">${currentLang === 'en' ? 'üîß Troubleshooting:' : 'üîß ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§®‡§ø‡§µ‡§æ‡§∞‡§£:'}</p>
                    <ol style="font-size: 0.9em; margin-left: 20px;">
                        <li>${currentLang === 'en' ? 'Check internet connection' : '‡§á‡§Ç‡§ü‡§∞‡§®‡•á‡§ü ‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® ‡§ú‡§æ‡§Ç‡§ö‡•á‡§Ç'}</li>
                        <li>${currentLang === 'en' ? 'Verify API key has credits at <a href="https://openrouter.ai/credits" target="_blank">OpenRouter</a>' : 'OpenRouter ‡§™‡§∞ API ‡§ï‡•Ä ‡§ï‡•ç‡§∞‡•á‡§°‡§ø‡§ü ‡§ú‡§æ‡§Ç‡§ö‡•á‡§Ç'}</li>
                        <li>${currentLang === 'en' ? 'Make sure app is hosted online (not file://)' : '‡§ê‡§™ ‡§ë‡§®‡§≤‡§æ‡§á‡§® ‡§π‡•ã‡§∏‡•ç‡§ü ‡§π‡•à (file:// ‡§®‡§π‡•Ä‡§Ç)'}</li>
                        <li>${currentLang === 'en' ? 'Check browser console (F12) for details' : '‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ ‡§ï‡§Ç‡§∏‡•ã‡§≤ (F12) ‡§ú‡§æ‡§Ç‡§ö‡•á‡§Ç'}</li>
                    </ol>`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = currentLang === 'en' ? 'üîç Detect Disease' : 'üîç ‡§∞‡•ã‡§ó ‡§ï‡§æ ‡§™‡§§‡§æ ‡§≤‡§ó‡§æ‡§è‡§Ç';
            }
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            const messagesDiv = document.getElementById('chatMessages');
            
            messagesDiv.innerHTML += `<div class="message user">${message}</div>`;
            input.value = '';
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            messagesDiv.innerHTML += `<div class="message ai"><span class="loading"></span> ${currentLang === 'en' ? 'Thinking...' : '‡§∏‡•ã‡§ö ‡§∞‡§π‡§æ ‡§π‡•Ç‡§Ç...'}</div>`;
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            try {
                const systemPrompt = currentLang === 'en'
                    ? 'You are an expert plant doctor. Answer questions about plant diseases, treatments, and care in a helpful and detailed way.'
                    : '‡§Ü‡§™ ‡§è‡§ï ‡§µ‡§ø‡§∂‡•á‡§∑‡§ú‡•ç‡§û ‡§™‡•å‡§ß‡•á ‡§°‡•â‡§ï‡•ç‡§ü‡§∞ ‡§π‡•à‡§Ç‡•§ ‡§™‡•å‡§ß‡•ã‡§Ç ‡§ï‡•Ä ‡§¨‡•Ä‡§Æ‡§æ‡§∞‡§ø‡§Ø‡•ã‡§Ç, ‡§â‡§™‡§ö‡§æ‡§∞ ‡§î‡§∞ ‡§¶‡•á‡§ñ‡§≠‡§æ‡§≤ ‡§ï‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§π‡§æ‡§Ø‡§ï ‡§î‡§∞ ‡§µ‡§ø‡§∏‡•ç‡§§‡•É‡§§ ‡§§‡§∞‡•Ä‡§ï‡•á ‡§∏‡•á ‡§ú‡§µ‡§æ‡§¨ ‡§¶‡•á‡§Ç‡•§';

                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Content-Type': 'application/json',
                        'HTTP-Referer': window.location.href,
                        'X-Title': 'Plant Disease Detector'
                    },
                    body: JSON.stringify({
                        model: 'anthropic/claude-3.5-sonnet',
                        messages: [
                            { role: 'system', content: systemPrompt },
                            { role: 'user', content: message }
                        ]
                    })
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }

                const data = await response.json();
                const lastMessage = messagesDiv.lastElementChild;
                
                if (data.choices && data.choices[0] && data.choices[0].message) {
                    lastMessage.textContent = data.choices[0].message.content;
                } else {
                    lastMessage.textContent = currentLang === 'en' 
                        ? '‚ùå Sorry, I could not process your request.' 
                        : '‚ùå ‡§ï‡•ç‡§∑‡§Æ‡§æ ‡§ï‡§∞‡•á‡§Ç, ‡§Æ‡•à‡§Ç ‡§Ü‡§™‡§ï‡•á ‡§Ö‡§®‡•Å‡§∞‡•ã‡§ß ‡§ï‡•ã ‡§∏‡§Ç‡§∏‡§æ‡§ß‡§ø‡§§ ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞ ‡§∏‡§ï‡§æ‡•§';
                }
            } catch (error) {
                console.error('Chat error:', error);
                const lastMessage = messagesDiv.lastElementChild;
                lastMessage.innerHTML = currentLang === 'en' 
                    ? '‚ùå Error connecting to AI.<br><small>Check credits at <a href="https://openrouter.ai/credits" target="_blank">OpenRouter</a></small>' 
                    : '‚ùå AI ‡§∏‡•á ‡§ï‡§®‡•á‡§ï‡•ç‡§ü ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø‡•§<br><small><a href="https://openrouter.ai/credits" target="_blank">OpenRouter</a> ‡§™‡§∞ ‡§ï‡•ç‡§∞‡•á‡§°‡§ø‡§ü ‡§ú‡§æ‡§Ç‡§ö‡•á‡§Ç</small>';
            }
            
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function askQuestion(element) {
            const question = element.textContent;
            document.getElementById('chatInput').value = question;
            sendChatMessage();
        }

        function downloadReport() {
            if (!lastAnalysis) {
                alert(currentLang === 'en' ? 'No analysis to download. Please detect a disease first.' : '‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ã‡§à ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§®‡§π‡•Ä‡§Ç‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡§π‡§≤‡•á ‡§∞‡•ã‡§ó ‡§ï‡§æ ‡§™‡§§‡§æ ‡§≤‡§ó‡§æ‡§è‡§Ç‡•§');
                return;
            }

            const blob = new Blob([lastAnalysis], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'plant-disease-report.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function shareReport() {
            if (!lastAnalysis) {
                alert(currentLang === 'en' ? 'No analysis to share. Please detect a disease first.' : '‡§∂‡•á‡§Ø‡§∞ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ã‡§à ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§®‡§π‡•Ä‡§Ç‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡§π‡§≤‡•á ‡§∞‡•ã‡§ó ‡§ï‡§æ ‡§™‡§§‡§æ ‡§≤‡§ó‡§æ‡§è‡§Ç‡•§');
                return;
            }

            if (navigator.share) {
                navigator.share({
                    title: 'Plant Disease Analysis',
                    text: lastAnalysis
                }).catch(err => console.log('Share failed:', err));
            } else {
                navigator.clipboard.writeText(lastAnalysis).then(() => {
                    alert(currentLang === 'en' ? '‚úÖ Report copied to clipboard!' : '‚úÖ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡•ç‡§≤‡§ø‡§™‡§¨‡•ã‡§∞‡•ç‡§° ‡§™‡§∞ ‡§ï‡•â‡§™‡•Ä ‡§π‡•ã ‡§ó‡§à!');
                });
            }
        }

        function clearAll() {
            selectedImage = null;
            lastAnalysis = null;
            document.getElementById('previewImage').style.display = 'none';
            document.getElementById('previewImage').src = '';
            document.getElementById('fileInput').value = '';
            document.getElementById('resultBox').innerHTML = '<p>' + (currentLang === 'en' ? 'Upload an image and click detect to see results...' : '‡§™‡§∞‡§ø‡§£‡§æ‡§Æ ‡§¶‡•á‡§ñ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§´‡•ã‡§ü‡•ã ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ ‡§°‡§ø‡§ü‡•á‡§ï‡•ç‡§ü ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç...') + '</p>';
            document.getElementById('detectBtn').disabled = true;
        }

        function showInstallGuide() {
            const msg = currentLang === 'en' 
                ? `üì± To Install This App:\n\nüñ•Ô∏è Desktop:\n‚Ä¢ Look for the install icon (‚äï) in your browser's address bar\n‚Ä¢ Or click browser menu (‚ãÆ) ‚Üí "Install Plant Disease Detector"\n\nüì± Mobile:\n‚Ä¢ Tap browser menu (‚ãÆ)\n‚Ä¢ Select "Add to Home Screen" or "Install App"\n\nüçé iPhone:\n‚Ä¢ Tap Share button\n‚Ä¢ Select "Add to Home Screen"\n\nThis app works offline once installed!`
                : `üì± ‡§á‡§∏ ‡§ê‡§™ ‡§ï‡•ã ‡§á‡§Ç‡§∏‡•ç‡§ü‡•â‡§≤ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è:\n\nüñ•Ô∏è ‡§°‡•á‡§∏‡•ç‡§ï‡§ü‡•â‡§™:\n‚Ä¢ ‡§Ö‡§™‡§®‡•á ‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ ‡§ï‡•á ‡§è‡§°‡•ç‡§∞‡•á‡§∏ ‡§¨‡§æ‡§∞ ‡§Æ‡•á‡§Ç ‡§á‡§Ç‡§∏‡•ç‡§ü‡•â‡§≤ ‡§Ü‡§á‡§ï‡§® (‚äï) ‡§¶‡•á‡§ñ‡•á‡§Ç\n‚Ä¢ ‡§Ø‡§æ ‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ ‡§Æ‡•á‡§®‡•Ç (‚ãÆ) ‚Üí "Plant Disease Detector ‡§á‡§Ç‡§∏‡•ç‡§ü‡•â‡§≤ ‡§ï‡§∞‡•á‡§Ç"\n\nüì± ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤:\n‚Ä¢ ‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ ‡§Æ‡•á‡§®‡•Ç (‚ãÆ) ‡§ü‡•à‡§™ ‡§ï‡§∞‡•á‡§Ç\n‚Ä¢ "‡§π‡•ã‡§Æ ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§® ‡§Æ‡•á‡§Ç ‡§ú‡•ã‡§°‡§º‡•á‡§Ç" ‡§ö‡•Å‡§®‡•á‡§Ç\n\nüçé iPhone:\n‚Ä¢ ‡§∂‡•á‡§Ø‡§∞ ‡§¨‡§ü‡§® ‡§ü‡•à‡§™ ‡§ï‡§∞‡•á‡§Ç\n‚Ä¢ "‡§π‡•ã‡§Æ ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§® ‡§Æ‡•á‡§Ç ‡§ú‡•ã‡§°‡§º‡•á‡§Ç" ‡§ö‡•Å‡§®‡•á‡§Ç\n\n‡§á‡§Ç‡§∏‡•ç‡§ü‡•â‡§≤ ‡§π‡•ã‡§®‡•á ‡§ï‡•á ‡§¨‡§æ‡§¶ ‡§Ø‡§π ‡§ê‡§™ ‡§ë‡§´‡§≤‡§æ‡§á‡§® ‡§ï‡§æ‡§Æ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à!`;
            alert(msg);
        }
    </script>
</body>
</html>